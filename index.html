<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bike Station Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 600px; }
    #controls { text-align: center; margin: 10px; }
    button { margin: 5px; padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #ddd; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Bike Station Heatmap</h2>
  <div id="map"></div>

  <!-- Controls -->
  <div id="controls">
    <label for="intensitySlider">Intensity: </label>
    <input type="range" id="intensitySlider" min="0.2" max="3" step="0.1" value="1">
    <span id="sliderValue">1.0</span>
    <br>
    <button onclick="toggleLayer(startsLayer)">Toggle Starts</button>
    <button onclick="toggleLayer(endsLayer)">Toggle Ends</button>
    <button onclick="toggleLayer(totalLayer)">Toggle Total</button>
    <button onclick="toggleLayer(markers)">Toggle Markers</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // Map setup
    const map = L.map('map').setView([39.95, -75.16], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let startsLayer, endsLayer, totalLayer, markers;
    let stations = [];
    let multiplier = 1;

    // Load Google Sheet CSV via PapaParse
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vS6hPbcRfXvDoEdor5z93DSF8_gaL7XDragNFXxtShmDZyEofT5lt0XahtlNDeJa36EP_B4ErL31u0n/pub?gid=1084593066&single=true&output=csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        console.log("Raw parsed:", results.data);

        // Clean + filter stations
        stations = results.data.map(r => {
          return {
            lat: parseFloat((r.start_lat || "").trim()),
            lon: parseFloat((r.start_lon || "").trim()),
            name: (r.Station_Name || "").trim(),
            starts: parseInt(r.Station_Starts || 0, 10),
            ends: parseInt(r.Station_Ends || 0, 10),
            activity: parseInt(r.Station_Activity || 0, 10)
          };
        }).filter(r => !isNaN(r.lat) && !isNaN(r.lon));

        console.log("Cleaned stations:", stations);

        if (stations.length === 0) {
          alert("No valid stations found. Check CSV headers!");
          return;
        }

        // Build heatmap datasets
        const heatData = makeHeat(multiplier);

        startsLayer = L.heatLayer(heatData.starts, { radius: 25, blur: 15 }).addTo(map);
        endsLayer   = L.heatLayer(heatData.ends,   { radius: 25, blur: 15 });
        totalLayer  = L.heatLayer(heatData.total,  { radius: 25, blur: 15 });

        // Markers
        markers = L.layerGroup(stations.map(s =>
          L.circleMarker([s.lat, s.lon], {
            radius: 4, color: "blue", fillOpacity: 0.7
          }).bindPopup(`<b>${s.name}</b><br>
            Starts: ${s.starts}<br>
            Ends: ${s.ends}<br>
            Activity: ${s.activity}`)
        )).addTo(map);

        // Auto-zoom to fit all stations
        const bounds = L.latLngBounds(stations.map(s => [s.lat, s.lon]));
        map.fitBounds(bounds);
      }
    });

    // Build heat datasets
    function makeHeat(mult) {
      return {
        starts: stations.map(s => [s.lat, s.lon, s.starts * mult]),
        ends:   stations.map(s => [s.lat, s.lon, s.ends * mult]),
        total:  stations.map(s => [s.lat, s.lon, s.activity * mult])
      };
    }

    // Intensity slider
    const slider = document.getElementById("intensitySlider");
    const label = document.getElementById("sliderValue");

    slider.addEventListener("input", () => {
      multiplier = parseFloat(slider.value);
      label.innerText = multiplier.toFixed(1);

      const heatData = makeHeat(multiplier);
      if (startsLayer) startsLayer.setLatLngs(heatData.starts);
      if (endsLayer)   endsLayer.setLatLngs(heatData.ends);
      if (totalLayer)  totalLayer.setLatLngs(heatData.total);
    });

    // Toggle function
    function toggleLayer(layer) {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
      } else {
        map.addLayer(layer);
      }
    }
  </script>
</body>
</html>
